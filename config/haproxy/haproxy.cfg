global
    daemon
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    master-worker

    # SSL/TLS Configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if LOCALHOST

# Frontend for HTTP traffic
frontend http_frontend
    bind *:80
    
    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s),http_err_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 50 }
    
    # Route based on path
    acl is_media_storage path_beg /api/v1/media/storage
    acl is_video_transcoding path_beg /api/v1/media/video
    acl is_image_optimizer path_beg /api/v1/media/images
    acl is_upload_service path_beg /api/v1/upload
    acl is_cdn_manager path_beg /api/v1/cdn
    acl is_media_analytics path_beg /api/v1/analytics
    acl is_responsive_delivery path_beg /api/v1/delivery
    
    use_backend media_storage_backend if is_media_storage
    use_backend video_transcoding_backend if is_video_transcoding
    use_backend image_optimizer_backend if is_image_optimizer
    use_backend upload_service_backend if is_upload_service
    use_backend cdn_manager_backend if is_cdn_manager
    use_backend media_analytics_backend if is_media_analytics
    use_backend responsive_delivery_backend if is_responsive_delivery
    
    default_backend main_api_backend

# HTTPS Frontend
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/cryb.pem
    
    # Force HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Same routing logic as HTTP
    acl is_media_storage path_beg /api/v1/media/storage
    acl is_video_transcoding path_beg /api/v1/media/video
    acl is_image_optimizer path_beg /api/v1/media/images
    acl is_upload_service path_beg /api/v1/upload
    acl is_cdn_manager path_beg /api/v1/cdn
    acl is_media_analytics path_beg /api/v1/analytics
    acl is_responsive_delivery path_beg /api/v1/delivery
    
    use_backend media_storage_backend if is_media_storage
    use_backend video_transcoding_backend if is_video_transcoding
    use_backend image_optimizer_backend if is_image_optimizer
    use_backend upload_service_backend if is_upload_service
    use_backend cdn_manager_backend if is_cdn_manager
    use_backend media_analytics_backend if is_media_analytics
    use_backend responsive_delivery_backend if is_responsive_delivery
    
    default_backend main_api_backend

# Backend for Media Storage Service
backend media_storage_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Health check configuration
    default-server inter 30s downinter 5s rise 2 fall 3
    
    # Dynamic server discovery would go here
    # For now, using static configuration
    server storage1 media-storage:3001 check
    server storage2 media-storage:3001 check
    server storage3 media-storage:3001 check

# Backend for Video Transcoding Service
backend video_transcoding_backend
    balance leastconn  # CPU intensive, use least connections
    option httpchk GET /health
    http-check expect status 200
    timeout server 300s  # Longer timeout for video processing
    
    server transcoder1 video-transcoding:3002 check
    server transcoder2 video-transcoding:3002 check

# Backend for Image Optimizer Service
backend image_optimizer_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server optimizer1 image-optimizer:3003 check
    server optimizer2 image-optimizer:3003 check
    server optimizer3 image-optimizer:3003 check
    server optimizer4 image-optimizer:3003 check

# Backend for Upload Service
backend upload_service_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    timeout server 180s  # Longer timeout for uploads
    
    server uploader1 upload-service:3004 check
    server uploader2 upload-service:3004 check
    server uploader3 upload-service:3004 check

# Backend for CDN Manager Service
backend cdn_manager_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server cdn1 cdn-manager:3006 check
    server cdn2 cdn-manager:3006 check

# Backend for Media Analytics Service
backend media_analytics_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server analytics1 media-analytics:3007 check
    server analytics2 media-analytics:3007 check

# Backend for Responsive Delivery Service
backend responsive_delivery_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server delivery1 responsive-delivery:3008 check
    server delivery2 responsive-delivery:3008 check
    server delivery3 responsive-delivery:3008 check

# Main API Backend (fallback)
backend main_api_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # These would be your main API servers
    server api1 cryb-api:3000 check
    server api2 cryb-api:3000 check