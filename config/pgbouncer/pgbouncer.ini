[databases]
; Primary database with optimized connection parameters
cryb = host=postgres port=5432 dbname=cryb user=cryb_user password=cryb_password pool_size=50 max_db_connections=60 connect_query='SET application_name=pgbouncer_cryb'

; Analytics database connection (TimescaleDB optimized)
cryb_analytics = host=postgres port=5432 dbname=cryb user=cryb_user password=cryb_password pool_size=20 max_db_connections=25 connect_query='SET application_name=pgbouncer_analytics'

; Read-only replica connection (if available)
; cryb_readonly = host=postgres-replica port=5432 dbname=cryb user=cryb_user password=cryb_password pool_size=30 max_db_connections=35

[pgbouncer]
; Connection pooling mode optimized for CRYB platform
; transaction: Best balance of connection reuse and transaction isolation
; Use session mode for admin tasks, transaction mode for app connections
pool_mode = transaction

; Network configuration
listen_addr = 0.0.0.0
listen_port = 6432

; Authentication optimized for performance
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

; Connection limits optimized for high-traffic platform
max_client_conn = 2000              ; Increased for platform scale
default_pool_size = 50              ; Optimized for server capacity
min_pool_size = 10                  ; Maintain minimum connections
reserve_pool_size = 10              ; Reserve for admin connections
max_prepared_statements = 100       ; Cache prepared statements

; Server connection limits
max_db_connections = 60             ; Increased based on PostgreSQL config
max_user_connections = 60           ; Per-user connection limit

; Server connection parameters optimized for performance
server_reset_query = DISCARD ALL
server_reset_query_always = 0       ; Only reset when needed
server_check_delay = 10              ; Check connection health more frequently
server_check_query = SELECT 1
server_fast_close = 1                ; Fast connection closure

; Client connection parameters optimized for CRYB platform
client_idle_timeout = 300            ; 5 minutes - balance between resource usage and UX
server_idle_timeout = 300            ; Match client timeout
server_lifetime = 7200               ; 2 hours - longer for better connection reuse
server_connect_timeout = 5           ; Faster timeout for better responsiveness
query_timeout = 300                  ; 5 minutes max query time
query_wait_timeout = 30              ; Shorter wait time for better UX
cancel_wait_timeout = 5              ; Quick cancellation for better responsiveness

; Connection state management
disable_pqexec = 0                   ; Enable prepared statements
application_name_add_host = 1
conffile = /etc/pgbouncer/pgbouncer.ini

; Logging optimized for production monitoring
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 30                    ; More frequent stats for monitoring
verbose = 0                          ; Reduce verbose logging in production
syslog = 1                          ; Enable syslog for centralized logging
syslog_facility = daemon
syslog_ident = pgbouncer

; Admin interface with enhanced security
admin_users = cryb_user, postgres
stats_users = cryb_user, postgres, monitoring_user

; Performance tuning optimized for CRYB workload
pkt_buf = 8192                      ; Increased buffer for better throughput
sbuf_loopcnt = 5
max_packet_size = 2147483647
listen_backlog = 128                ; Increased backlog for high concurrency
so_reuseport = 1                    ; Enable SO_REUSEPORT for better performance

; SSL/TLS configuration
server_tls_sslmode = prefer          ; Prefer SSL when available
client_tls_sslmode = prefer
server_tls_protocols = secure        ; Use secure TLS protocols only
server_tls_ciphers = HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA

; TCP settings optimized for AWS/cloud environment
tcp_defer_accept = 1                ; Defer accept for better performance
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 300                  ; 5 minutes
tcp_keepintvl = 30
tcp_socket_buffer = 0               ; Use system defaults
tcp_user_timeout = 30000            ; 30 seconds

; DNS and hostname resolution
dns_max_ttl = 15                    ; Short TTL for dynamic environments
dns_nxdomain_ttl = 15
dns_zone_check_period = 0

; Ignore startup parameters that applications might send
ignore_startup_parameters = extra_float_digits, search_path, timezone, geqo, statement_timeout

; Connection routing and load balancing
; server_round_robin = 1             ; Uncomment for round-robin server selection

; Advanced pooling configuration
pool_mode_override = transaction     ; Override for specific databases if needed
default_pool_size_override = 0      ; Per-database pool size override

; Monitoring and health checks
health_check_period = 30            ; Health check every 30 seconds
health_check_timeout = 15           ; Timeout for health checks