# PostgreSQL Configuration for CRYB Platform
# Optimized for production use with TimescaleDB

# === CONNECTION SETTINGS ===
listen_addresses = '*'
port = 5432
max_connections = 200                    # Increased from 25 for production
superuser_reserved_connections = 3

# === MEMORY SETTINGS ===
# Shared buffers should be ~25% of system RAM (assuming 4GB system)
shared_buffers = 1GB
effective_cache_size = 3GB               # ~75% of system RAM
work_mem = 16MB                          # Per operation memory
maintenance_work_mem = 256MB
dynamic_shared_memory_type = posix

# === CHECKPOINT SETTINGS ===
wal_buffers = 16MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
checkpoint_flush_after = 256kB

# === LOGGING SETTINGS ===
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000        # Log slow queries (1 second)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB

# === PERFORMANCE TUNING ===
random_page_cost = 1.1                  # For SSD storage
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025
effective_io_concurrency = 200          # For SSD storage

# === AUTOVACUUM SETTINGS ===
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 400

# === WAL SETTINGS ===
wal_level = replica
max_wal_senders = 3
archive_mode = on
archive_command = '/bin/true'            # Placeholder, configure for real backups
wal_compression = on
wal_log_hints = on

# === QUERY PLANNER ===
default_statistics_target = 100
constraint_exclusion = partition
cursor_tuple_fraction = 0.1
from_collapse_limit = 8
join_collapse_limit = 8

# === BACKGROUND WRITER ===
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# === TIMESCALEDB SETTINGS ===
shared_preload_libraries = 'timescaledb'
timescaledb.max_background_workers = 8
timescaledb.telemetry_level = off

# === STATEMENT TIMEOUT ===
statement_timeout = 300s                # 5 minutes max query time
lock_timeout = 30s
idle_in_transaction_session_timeout = 60s

# === CONNECTION POOLING PREPARATION ===
# These settings work well with PgBouncer/connection pooling
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# === LOCALE SETTINGS ===
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# === TIMEZONE ===
timezone = 'UTC'
log_timezone = 'UTC'