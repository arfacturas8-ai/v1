# ==============================================
# CRYB WEB - DEVELOPMENT DOCKERFILE
# ==============================================

FROM node:20.11.1-alpine AS development

# Install system dependencies
RUN apk add --no-cache libc6-compat curl

# Set working directory
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@8.15.0

# Copy package files first for better caching
COPY package*.json pnpm-lock.yaml ./

# Install ALL dependencies (dev + prod) for development
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Create necessary directories
RUN mkdir -p /app/.next

# Copy health check script
COPY docker/healthcheck.js ./healthcheck.js

# Expose port
EXPOSE 3000

# Set environment variables for development
ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME=0.0.0.0
ENV NEXT_TELEMETRY_DISABLED=1
ENV FAST_REFRESH=true
ENV CHOKIDAR_USEPOLLING=true
ENV WATCHPACK_POLLING=true

# Add health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# Development command with hot reloading
CMD ["pnpm", "dev"]