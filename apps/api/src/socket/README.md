# Real-time Communication System\n\nA production-ready, scalable real-time communication system built with Socket.io, Redis, and comprehensive event handling.\n\n##  Features\n\n### Core Communication\n- **Scalable Socket.io**: Horizontal scaling with Redis adapter\n- **Advanced Authentication**: JWT validation with user verification\n- **Real-time Messaging**: Message delivery with read receipts\n- **Direct Messages**: Private messaging with encryption support\n- **Message Reactions**: Add/remove reactions with real-time updates\n- **Message Threading**: Reply to messages with context preservation\n\n### Presence & Status\n- **Presence Tracking**: Online/offline status with device detection\n- **Heartbeat Monitoring**: Automatic presence updates with cleanup\n- **Status Broadcasting**: Share activity and status with friends\n- **Typing Indicators**: Real-time typing with auto-cleanup\n- **Last Seen**: Track user activity timestamps\n\n### Voice & Video\n- **Voice Channels**: Join/leave voice channels with state sync\n- **Voice State Management**: Mute, deafen, speaking indicators\n- **Video Support**: Camera and screen sharing states\n- **LiveKit Integration**: Professional voice/video with token generation\n\n### Advanced Features\n- **Room Management**: Dynamic channel joining/leaving\n- **Cross-server Communication**: Redis pub/sub for scaling\n- **Rate Limiting**: Multi-tier abuse prevention\n- **Moderation Tools**: Real-time kick, ban, and permission management\n- **Analytics**: Comprehensive metrics and monitoring\n- **Error Handling**: Graceful error recovery and logging\n\n## üèóÔ∏è Architecture\n\n### System Components\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ   Client Apps       ‚îÇ    ‚îÇ   Load Balancer     ‚îÇ    ‚îÇ   Server Cluster    ‚îÇ\n‚îÇ                     ‚îÇ    ‚îÇ                     ‚îÇ    ‚îÇ                     ‚îÇ\n‚îÇ ‚Ä¢ Web App           ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ Nginx/HAProxy     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ Node.js + Fastify ‚îÇ\n‚îÇ ‚Ä¢ Mobile App        ‚îÇ    ‚îÇ ‚Ä¢ SSL Termination   ‚îÇ    ‚îÇ ‚Ä¢ Socket.io Server  ‚îÇ\n‚îÇ ‚Ä¢ Desktop App       ‚îÇ    ‚îÇ ‚Ä¢ Health Checks     ‚îÇ    ‚îÇ ‚Ä¢ Redis Adapter     ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n                                                                     ‚îÇ\n                                                                     ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ   Redis Cluster     ‚îÇ    ‚îÇ   Database          ‚îÇ    ‚îÇ   Monitoring        ‚îÇ\n‚îÇ                     ‚îÇ    ‚îÇ                     ‚îÇ    ‚îÇ                     ‚îÇ\n‚îÇ ‚Ä¢ Pub/Sub           ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ PostgreSQL        ‚îÇ    ‚îÇ ‚Ä¢ Metrics Dashboard ‚îÇ\n‚îÇ ‚Ä¢ Caching           ‚îÇ    ‚îÇ ‚Ä¢ Prisma ORM        ‚îÇ    ‚îÇ ‚Ä¢ Real-time Analytics‚îÇ\n‚îÇ ‚Ä¢ Session Storage   ‚îÇ    ‚îÇ ‚Ä¢ User Data         ‚îÇ    ‚îÇ ‚Ä¢ Alert System     ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n### File Structure\n\n```\nsrc/socket/\n‚îú‚îÄ‚îÄ realtime-communication.ts      # Main service class\n‚îú‚îÄ‚îÄ realtime-communication-handlers.ts  # Event handlers\n‚îú‚îÄ‚îÄ redis-pubsub.ts                # Cross-server communication\n‚îú‚îÄ‚îÄ realtime-analytics.ts          # Metrics and monitoring\n‚îú‚îÄ‚îÄ enhanced-index.ts              # Enhanced setup and utilities\n‚îî‚îÄ‚îÄ README.md                      # This documentation\n```\n\n## üìã Event Reference\n\n### Connection Events\n- `connect` - User connects to the system\n- `disconnect` - User disconnects from the system\n- `heartbeat` - Periodic connectivity check\n- `ping/pong` - Network latency measurement\n\n### Message Events\n- `message:send` - Send a new message\n- `message:edit` - Edit an existing message\n- `message:delete` - Delete a message\n- `message:react` - Add/remove message reaction\n- `message:new` - Broadcast new message to channel\n- `message:edited` - Broadcast message edit\n- `message:deleted` - Broadcast message deletion\n- `message:reaction` - Broadcast reaction change\n\n### Channel Events\n- `channel:join` - Join a channel\n- `channel:leave` - Leave a channel\n- `channel:get_history` - Retrieve message history\n- `channel:joined` - Confirmation of channel join\n- `channel:left` - Confirmation of channel leave\n- `channel:member_joined` - User joined channel broadcast\n- `channel:member_left` - User left channel broadcast\n\n### Presence Events\n- `presence:update` - Update user status/activity\n- `presence:get_bulk` - Get presence for multiple users\n- `presence:heartbeat` - Keep presence alive\n- `friend:online` - Friend came online\n- `friend:offline` - Friend went offline\n\n### Typing Events\n- `typing:start` - Start typing indicator\n- `typing:stop` - Stop typing indicator\n- `typing:user_start` - User started typing broadcast\n- `typing:user_stop` - User stopped typing broadcast\n- `typing:get_active` - Get active typing users\n\n### Voice Events\n- `voice:join` - Join voice channel\n- `voice:leave` - Leave voice channel\n- `voice:update` - Update voice state\n- `voice:get_participants` - Get voice participants\n- `voice:user_joined` - User joined voice broadcast\n- `voice:user_left` - User left voice broadcast\n- `voice:state_update` - Voice state change broadcast\n\n### Direct Message Events\n- `dm:send` - Send direct message\n- `dm:get_conversations` - Get DM conversations\n- `dm:new` - New direct message received\n- `dm:sent` - DM sent confirmation\n\n### Read Receipt Events\n- `message:mark_read` - Mark message as read\n- `message:get_read_receipts` - Get read receipts\n- `message:read_receipt` - Read receipt broadcast\n\n### Moderation Events\n- `moderation:kick_user` - Kick user from server\n- `moderation:ban_user` - Ban user from server\n- `moderation:user_kicked` - User kicked broadcast\n- `moderation:user_banned` - User banned broadcast\n- `moderation:kicked` - You were kicked notification\n- `moderation:banned` - You were banned notification\n\n##  Configuration\n\n### Environment Variables\n\n```bash\n# Redis Configuration\nREDIS_URL=redis://:password@localhost:6380/0\nREDIS_HOST=localhost\nREDIS_PORT=6380\nREDIS_PASSWORD=password\n\n# Server Configuration\nSERVER_ID=server-1\nALLOWED_ORIGINS=http://localhost:3000,http://localhost:3002\n\n# JWT Configuration\nJWT_SECRET=your-secret-key\n\n# Voice Configuration (LiveKit)\nLIVEKIT_URL=ws://localhost:7880\nLIVEKIT_API_KEY=devkey\nLIVEKIT_API_SECRET=secret\n```\n\n### Rate Limiting Configuration\n\n```typescript\nconst RATE_LIMITS = {\n  'message:send': { window: 60000, max: 30 },    // 30 messages per minute\n  'typing:start': { window: 10000, max: 10 },   // 10 typing events per 10s\n  'presence:update': { window: 30000, max: 5 }, // 5 presence updates per 30s\n  'voice:update': { window: 5000, max: 20 },    // 20 voice updates per 5s\n  'channel:join': { window: 60000, max: 50 },   // 50 channel joins per minute\n  'default': { window: 60000, max: 100 }        // 100 events per minute default\n};\n```\n\n##  Usage Examples\n\n### Basic Setup\n\n```typescript\nimport { FastifyInstance } from 'fastify';\nimport { setupEnhancedSocketHandlers } from './socket/enhanced-index';\n\n// In your Fastify app setup\nconst app = Fastify();\nconst io = new Server(app.server);\n\n// Initialize enhanced real-time communication\nsetupEnhancedSocketHandlers(io, app);\n```\n\n### Client Connection\n\n```typescript\nimport { io } from 'socket.io-client';\n\nconst socket = io('http://localhost:3000', {\n  auth: {\n    token: 'your-jwt-token'\n  }\n});\n\n// Handle connection\nsocket.on('connect', () => {\n  console.log('Connected to real-time server');\n});\n\n// Send a message\nsocket.emit('message:send', {\n  channelId: 'channel-id',\n  content: 'Hello, world!',\n  mentions: ['user-id-1']\n}, (response) => {\n  console.log('Message sent:', response);\n});\n\n// Listen for new messages\nsocket.on('message:new', (message) => {\n  console.log('New message received:', message);\n});\n```\n\n### Presence Management\n\n```typescript\n// Update your status\nsocket.emit('presence:update', {\n  status: 'online',\n  activity: {\n    type: 'playing',\n    name: 'Awesome Game',\n    details: 'Level 42'\n  }\n});\n\n// Listen for friend status updates\nsocket.on('friend:online', (data) => {\n  console.log(`${data.username} came online`);\n});\n\n// Send heartbeat to maintain presence\nsetInterval(() => {\n  socket.emit('presence:heartbeat');\n}, 30000);\n```\n\n### Voice Channel Management\n\n```typescript\n// Join voice channel\nsocket.emit('voice:join', { channelId: 'voice-channel-id' }, (response) => {\n  if (response.success) {\n    const { token, serverUrl } = response;\n    // Use token with LiveKit or your voice provider\n    connectToVoiceServer(token, serverUrl);\n  }\n});\n\n// Update voice state\nsocket.emit('voice:update', {\n  muted: true,\n  deafened: false,\n  speaking: false\n});\n\n// Listen for voice state changes\nsocket.on('voice:state_update', (data) => {\n  console.log(`${data.userId} updated voice state:`, data.voiceState);\n});\n```\n\n### Typing Indicators\n\n```typescript\nlet typingTimeout;\n\n// Start typing\nfunction startTyping(channelId) {\n  socket.emit('typing:start', { channelId });\n  \n  clearTimeout(typingTimeout);\n  typingTimeout = setTimeout(() => {\n    socket.emit('typing:stop', { channelId });\n  }, 10000); // Auto-stop after 10 seconds\n}\n\n// Listen for typing indicators\nsocket.on('typing:user_start', (data) => {\n  showTypingIndicator(data.userId, data.username);\n});\n\nsocket.on('typing:user_stop', (data) => {\n  hideTypingIndicator(data.userId);\n});\n```\n\n##  Monitoring & Analytics\n\n### Health Check\n\n```bash\ncurl http://localhost:3000/health\n```\n\nResponse:\n```json\n{\n  \"status\": \"healthy\",\n  \"timestamp\": \"2024-01-01T00:00:00.000Z\",\n  \"checks\": {\n    \"api\": \"healthy\",\n    \"database\": \"healthy\",\n    \"redis\": \"healthy\",\n    \"elasticsearch\": \"healthy\",\n    \"minio\": \"healthy\",\n    \"realtime\": \"healthy\"\n  }\n}\n```\n\n### Metrics Endpoint\n\n```bash\ncurl http://localhost:3000/metrics\n```\n\nResponse:\n```json\n{\n  \"websocket_connections\": 1234,\n  \"realtime_active_connections\": 1200,\n  \"realtime_total_connections\": 45678,\n  \"realtime_messages_sent\": 123456,\n  \"realtime_events_processed\": 567890,\n  \"realtime_presence_count\": 1100,\n  \"realtime_voice_connections\": 150,\n  \"system_health\": {\n    \"api\": \"healthy\",\n    \"realtime\": \"healthy\",\n    \"timestamp\": \"2024-01-01T00:00:00.000Z\"\n  }\n}\n```\n\n### Analytics Dashboard Data\n\n```typescript\nimport { getRealtimeAnalytics } from './socket/enhanced-index';\n\n// Get analytics data\nconst analytics = await getRealtimeAnalytics('message_sent', 100);\nconsole.log('Message analytics:', analytics);\n```\n\n##  Security Features\n\n### Authentication\n- JWT token validation on connection\n- User verification against database\n- Ban status checking\n- Session management\n\n### Rate Limiting\n- Per-event type rate limits\n- Per-user rate tracking\n- Configurable time windows\n- Automatic abuse prevention\n\n### Permission System\n- Channel access validation\n- Server membership verification\n- Role-based permissions\n- Moderation action authorization\n\n### Data Validation\n- Input sanitization\n- Message content validation\n- Event payload verification\n- Error boundary protection\n\n##  Performance Optimizations\n\n### Caching Strategy\n- In-memory presence cache\n- Redis-backed session storage\n- Message history caching\n- User data caching\n\n### Network Optimization\n- WebSocket compression\n- Binary frame support\n- Connection pooling\n- Efficient event serialization\n\n### Scaling Features\n- Redis adapter for horizontal scaling\n- Cross-server pub/sub communication\n- Load balancer compatibility\n- Graceful shutdown handling\n\n## üö® Error Handling\n\n### Connection Errors\n- Automatic reconnection\n- Exponential backoff\n- Connection state recovery\n- Graceful degradation\n\n### Message Delivery\n- Delivery acknowledgments\n- Retry mechanisms\n- Dead letter queues\n- Error tracking\n\n### System Recovery\n- Circuit breaker patterns\n- Health check automation\n- Alert system integration\n- Automatic failover\n\n##  Scaling Considerations\n\n### Horizontal Scaling\n- Multiple server instances\n- Redis cluster support\n- Session affinity handling\n- Cross-server synchronization\n\n### Performance Monitoring\n- Real-time metrics collection\n- Performance alerting\n- Resource usage tracking\n- Predictive scaling\n\n### Capacity Planning\n- Connection limit management\n- Message throughput monitoring\n- Resource allocation\n- Growth projection\n\n## üõ†Ô∏è Development & Testing\n\n### Local Development\n```bash\n# Install dependencies\nnpm install\n\n# Start Redis\ndocker run -p 6380:6379 redis:7-alpine\n\n# Start the server\nnpm run dev\n```\n\n### Testing\n```bash\n# Run unit tests\nnpm test\n\n# Run integration tests\nnpm run test:integration\n\n# Run load tests\nnpm run test:load\n```\n\n### Debugging\n- Enable debug logging: `DEBUG=socket.io:* npm run dev`\n- Use Socket.io admin UI for monitoring\n- Check Redis keys for state inspection\n- Monitor metrics endpoint for performance\n\n##  Production Deployment\n\n### Infrastructure Requirements\n- Node.js 18+ runtime\n- Redis 7+ cluster\n- Load balancer (Nginx/HAProxy)\n- SSL/TLS certificates\n- Monitoring system (Prometheus/Grafana)\n\n### Environment Setup\n- Set production environment variables\n- Configure Redis cluster\n- Set up SSL termination\n- Configure monitoring alerts\n- Deploy with PM2 or Docker\n\n### Maintenance\n- Regular health checks\n- Performance monitoring\n- Security updates\n- Capacity planning\n- Backup strategies\n\nThis comprehensive real-time communication system provides enterprise-grade features for modern applications requiring scalable, reliable real-time functionality."