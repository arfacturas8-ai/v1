import React, { useState, useEffect, useRef } from 'react'
import {
  Plus, Filter, TrendingUp, Clock, MessageSquare,
  Pin, Eye, ArrowUp, ArrowDown, Share, Bookmark,
  MoreHorizontal, Flag, Edit, Trash2, Crown
} from 'lucide-react'
import communityService from '../../services/communityService'
import socketService from '../../services/socket'
import { useConfirmationDialog } from '../ui/modal'
import CreatePost from '../post/CreatePost'


export default function CommunityFeed({
  communityId,
  currentUser,
  community,
  canModerate = false
}) {
  const [posts, setPosts] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  const [sortBy, setSortBy] = useState('hot') // hot, new, top, rising
  const [timeRange, setTimeRange] = useState('all') // hour, day, week, month, year, all
  const [showCreatePost, setShowCreatePost] = useState(false)
  const [pagination, setPagination] = useState({ page: 1, hasMore: true })
  const [selectedPost, setSelectedPost] = useState(null)
  const [showPostActions, setShowPostActions] = useState(null)
  const feedRef = useRef(null)
  const { confirm, ConfirmationDialog } = useConfirmationDialog()
  useEffect(() => {
    loadPosts(true)
    
    // Subscribe to real-time updates
    socketService.subscribeToCommunity(communityId)
    
    // Set up event listeners
    socketService.on('community_post_created', handlePostCreated)
    socketService.on('community_post_updated', handlePostUpdated)
    socketService.on('community_post_deleted', handlePostDeleted)
    socketService.on('community_post_vote_updated', handleVoteUpdated)
    
    return () => {
      socketService.unsubscribeFromCommunity(communityId)
      socketService.off('community_post_created', handlePostCreated)
      socketService.off('community_post_updated', handlePostUpdated)
      socketService.off('community_post_deleted', handlePostDeleted)
      socketService.off('community_post_vote_updated', handleVoteUpdated)
    }
  }, [communityId])\n\n  useEffect(() => {\n    if (sortBy || timeRange) {\n      loadPosts(true)\n    }\n  }, [sortBy, timeRange])\n\n  const loadPosts = async (reset = false) => {\n    try {\n      setLoading(reset)\n      setError(null)\n      \n      const options = {\n        page: reset ? 1 : pagination.page,\n        limit: 25,\n        sort: sortBy,\n        timeRange,\n        communityId\n      }\n      \n      const result = await communityService.getPosts(options)\n      \n      if (result.success) {\n        if (reset) {\n          setPosts(result.posts)\n          setPagination({ page: 1, hasMore: result.pagination?.hasMore ?? false })\n        } else {\n          setPosts(prev => [...prev, ...result.posts])\n          setPagination(prev => ({ \n            page: prev.page + 1, \n            hasMore: result.pagination?.hasMore ?? false \n          }))\n        }\n      } else {\n        setError(result.error)\n      }\n    } catch (error) {\n      console.error('Failed to load posts:', error)\n      setError('Failed to load posts')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Real-time event handlers\n  const handlePostCreated = (post) => {\n    if (post.communityId === communityId) {\n      setPosts(prev => [post, ...prev])\n    }\n  }\n\n  const handlePostUpdated = (updatedPost) => {\n    if (updatedPost.communityId === communityId) {\n      setPosts(prev => prev.map(post => \n        post.id === updatedPost.id ? updatedPost : post\n      ))\n    }\n  }\n\n  const handlePostDeleted = (postId) => {\n    setPosts(prev => prev.filter(post => post.id !== postId))\n  }\n\n  const handleVoteUpdated = (data) => {\n    if (data.communityId === communityId) {\n      setPosts(prev => prev.map(post => \n        post.id === data.postId \n          ? { \n              ...post, \n              upvotes: data.upvotes, \n              downvotes: data.downvotes,\n              userVote: data.userVote \n            }\n          : post\n      ))\n    }\n  }\n\n  const handleVote = async (postId, voteType) => {\n    try {\n      // Optimistic update\n      const post = posts.find(p => p.id === postId)\n      if (!post) return\n      \n      let newUpvotes = post.upvotes\n      let newDownvotes = post.downvotes\n      let newUserVote = voteType\n      \n      // Remove previous vote\n      if (post.userVote === 'up') newUpvotes--\n      if (post.userVote === 'down') newDownvotes--\n      \n      // Add new vote or remove if same\n      if (voteType === post.userVote) {\n        newUserVote = null // Remove vote\n      } else {\n        if (voteType === 'up') newUpvotes++\n        if (voteType === 'down') newDownvotes++\n      }\n      \n      // Update UI immediately\n      setPosts(prev => prev.map(p => \n        p.id === postId \n          ? { \n              ...p, \n              upvotes: newUpvotes, \n              downvotes: newDownvotes,\n              userVote: newUserVote \n            }\n          : p\n      ))\n      \n      // Send to server\n      const result = await communityService.votePost(postId, newUserVote || 'remove')\n      \n      if (!result.success) {\n        // Revert on error\n        setPosts(prev => prev.map(p => \n          p.id === postId ? post : p\n        ))\n        setError(result.error)\n      }\n    } catch (error) {\n      console.error('Failed to vote:', error)\n      setError('Failed to vote on post')\n    }\n  }\n\n  const handleSavePost = async (postId) => {\n    try {\n      const post = posts.find(p => p.id === postId)\n      const result = await communityService.savePost(postId, !post.isSaved)\n      \n      if (result.success) {\n        setPosts(prev => prev.map(p => \n          p.id === postId ? { ...p, isSaved: !p.isSaved } : p\n        ))\n      } else {\n        setError(result.error)\n      }\n    } catch (error) {\n      console.error('Failed to save post:', error)\n      setError('Failed to save post')\n    }\n  }\n\n  const handleDeletePost = async (postId) => {\n    if (!window.confirm('Are you sure you want to delete this post?')) return\n    \n    try {\n      const result = await communityService.deletePost(postId)\n      \n      if (result.success) {\n        setPosts(prev => prev.filter(p => p.id !== postId))\n      } else {\n        setError(result.error)\n      }\n    } catch (error) {\n      console.error('Failed to delete post:', error)\n      setError('Failed to delete post')\n    }\n  }\n\n  const handlePinPost = async (postId, pin = true) => {\n    try {\n      const result = await communityService.updatePost(postId, { isPinned: pin })\n      \n      if (result.success) {\n        setPosts(prev => prev.map(p => \n          p.id === postId ? { ...p, isPinned: pin } : p\n        ))\n      } else {\n        setError(result.error)\n      }\n    } catch (error) {\n      console.error('Failed to pin post:', error)\n      setError('Failed to pin post')\n    }\n  }\n\n  const handleCreatePost = (newPost) => {\n    setPosts(prev => [newPost, ...prev])\n    setShowCreatePost(false)\n  }\n\n  const loadMore = () => {\n    if (!loading && pagination.hasMore) {\n      loadPosts()\n    }\n  }\n\n  const formatNumber = (num) => {\n    if (num >= 1000) {\n      return (num / 1000).toFixed(1) + 'k'\n    }\n    return num?.toString() || '0'\n  }\n\n  const getTimeSince = (date) => {\n    const now = new Date()\n    const postDate = new Date(date)\n    const diffInHours = Math.floor((now - postDate) / (1000 * 60 * 60))\n    \n    if (diffInHours < 1) {\n      const diffInMinutes = Math.floor((now - postDate) / (1000 * 60))\n      return `${diffInMinutes}m ago`\n    } else if (diffInHours < 24) {\n      return `${diffInHours}h ago`\n    } else {\n      const diffInDays = Math.floor(diffInHours / 24)\n      return `${diffInDays}d ago`\n    }\n  }\n\n  const canEditPost = (post) => {\n    return post.authorId === currentUser?.id || canModerate\n  }\n\n  const canDeletePost = (post) => {\n    return post.authorId === currentUser?.id || canModerate\n  }\n\n  const canPinPost = () => {\n    return canModerate\n  }\n\n  if (loading && posts.length === 0) {\n    return (\n      <div className=\"community-feed\">\n        <div className=\"loading-state\">\n          <div className=\"spinner\"></div>\n          <p>Loading posts...</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"community-feed\" ref={feedRef}>\n      {/* Feed Header */}\n      <div className=\"feed-header\">\n        <div className=\"sort-controls\">\n          <button\n            className={`sort-btn ${sortBy === 'hot' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}\n            onClick={() => setSortBy('hot')}\n          >\n            <TrendingUp size={16} />\n            Hot\n          </button>\n          <button\n            className={`sort-btn ${sortBy === 'new' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}\n            onClick={() => setSortBy('new')}\n          >\n            <Clock size={16} />\n            New\n          </button>\n          <button\n            className={`sort-btn ${sortBy === 'top' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}\n            onClick={() => setSortBy('top')}\n          >\n            <ArrowUp size={16} />\n            Top\n          </button>\n          <button\n            className={`sort-btn ${sortBy === 'rising' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}\n            onClick={() => setSortBy('rising')}\n          >\n            <TrendingUp size={16} />\n            Rising\n          </button>\n        </div>\n\n        {sortBy === 'top' && (\n          <select \n            value={timeRange} \n            onChange={(e) => setTimeRange(e.target.value)}\n            className=\"time-range-select\"\n          >\n            <option value=\"hour\">Past Hour</option>\n            <option value=\"day\">Past 24 Hours</option>\n            <option value=\"week\">Past Week</option>\n            <option value=\"month\">Past Month</option>\n            <option value=\"year\">Past Year</option>\n            <option value=\"all\">All Time</option>\n          </select>\n        )}\n\n        <button \n          className=\"create-post-btn\"\n          onClick={() => setShowCreatePost(true)}\n        >\n          <Plus size={16} />\n          Create Post\n        </button>\n      </div>\n\n      {/* Error Message */}\n      {error && (\n        <div className=\"error-message\">\n          <p>{error}</p>\n          <button onClick={() => setError(null)}>Dismiss</button>\n        </div>\n      )}\n\n      {/* Posts Feed */}\n      <div className=\"posts-container\">\n        {posts.map(post => (\n          <div key={post.id} className={`post-card ${post.isPinned ? 'pinned' : ''}`}>\n            {post.isPinned && (\n              <div className=\"pin-indicator\">\n                <Pin size={14} />\n                <span>Pinned by moderators</span>\n              </div>\n            )}\n\n            <div className=\"post-header\">\n              <div className=\"post-author\">\n                <img \n                  src={post.author?.avatar || '/default-avatar.png'} \n                  alt={post.author?.username}\n                  className=\"author-avatar\"\n                />\n                <div className=\"author-info\">\n                  <span className=\"author-name\">\n                    {post.author?.username}\n                    {post.author?.role === 'owner' && <Crown size={14} className=\"role-crown\" />}\n                  </span>\n                  <span className=\"post-time\">{getTimeSince(post.createdAt)}</span>\n                </div>\n              </div>\n\n              <div className=\"post-actions-menu\">\n                <button \n                  className=\"actions-btn\"\n                  onClick={() => setShowPostActions(\n                    showPostActions === post.id ? null : post.id\n                  )}\n                >\n                  <MoreHorizontal size={16} />\n                </button>\n\n                {showPostActions === post.id && (\n                  <div className=\"actions-dropdown\">\n                    {canPinPost() && (\n                      <button\n                        onClick={() => handlePinPost(post.id, !post.isPinned)}\n                        className=\"action-item\"\n                      >\n                        <Pin size={14} />\n                        {post.isPinned ? 'Unpin' : 'Pin'} Post\n                      </button>\n                    )}\n                    \n                    {canEditPost(post) && (\n                      <button className=\"action-item\">\n                        <Edit size={14} />\n                        Edit Post\n                      </button>\n                    )}\n                    \n                    <button \n                      onClick={() => handleSavePost(post.id)}\n                      className=\"action-item\"\n                    >\n                      <Bookmark size={14} />\n                      {post.isSaved ? 'Unsave' : 'Save'} Post\n                    </button>\n                    \n                    <button className=\"action-item\">\n                      <Share size={14} />\n                      Share\n                    </button>\n                    \n                    <button className=\"action-item\">\n                      <Flag size={14} />\n                      Report\n                    </button>\n                    \n                    {canDeletePost(post) && (\n                      <button \n                        onClick={() => handleDeletePost(post.id)}\n                        className=\"action-item danger\"\n                      >\n                        <Trash2 size={14} />\n                        Delete\n                      </button>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div className=\"post-content\">\n              <h3 className=\"post-title\">{post.title}</h3>\n              \n              {post.content && (\n                <div className=\"post-body\">\n                  {post.content}\n                </div>\n              )}\n              \n              {post.media && post.media.length > 0 && (\n                <div className=\"post-media\">\n                  {post.media.map((media, index) => (\n                    <img \n                      key={index}\n                      src={media.url} \n                      alt={`Post media ${index + 1}`}\n                      className=\"media-item\"\n                    />\n                  ))}\n                </div>\n              )}\n              \n              {post.url && (\n                <div className=\"post-link\">\n                  <a href={post.url} target=\"_blank\" rel=\"noopener noreferrer\">\n                    {post.url}\n                  </a>\n                </div>\n              )}\n            </div>\n\n            <div className=\"post-footer\">\n              <div className=\"vote-controls\">\n                <button \n                  className={`vote-btn ${post.userVote === 'up' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}\n                  onClick={() => handleVote(post.id, 'up')}\n                >\n                  <ArrowUp size={16} />\n                </button>\n                <span className=\"vote-count\">\n                  {formatNumber((post.upvotes || 0) - (post.downvotes || 0))}\n                </span>\n                <button \n                  className={`vote-btn ${post.userVote === 'down' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`}\n                  onClick={() => handleVote(post.id, 'down')}\n                >\n                  <ArrowDown size={16} />\n                </button>\n              </div>\n\n              <button className=\"comment-btn\">\n                <MessageSquare size={16} />\n                {formatNumber(post.commentCount || 0)} comments\n              </button>\n\n              <div className=\"post-stats\">\n                <span className=\"view-count\">\n                  <Eye size={14} />\n                  {formatNumber(post.viewCount || 0)}\n                </span>\n              </div>\n            </div>\n          </div>\n        ))}\n\n        {/* Load More */}\n        {pagination.hasMore && (\n          <div className=\"load-more-container\">\n            <button \n              className=\"load-more-btn\"\n              onClick={loadMore}\n              disabled={loading}\n            >\n              {loading ? '' : 'Load More Posts'}\n            </button>\n          </div>\n        )}\n\n        {posts.length === 0 && !loading && (\n          <div className=\"empty-feed\">\n            <MessageSquare size={48} />\n            <h3>No posts yet</h3>\n            <p>Be the first to share something with this community!</p>\n            <button \n              className=\"create-first-post\"\n              onClick={() => setShowCreatePost(true)}\n            >\n              <Plus size={16} />\n              Create Post\n            </button>\n          </div>\n        )}\n      </div>\n\n      {/* Create Post Modal */}\n      {showCreatePost && (\n        <CreatePost\n          communityId={communityId}\n          onClose={() => setShowCreatePost(false)}\n          onCreate={handleCreatePost}\n        />\n      )}\n    </div>\n  )\n}
