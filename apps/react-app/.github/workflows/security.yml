name: Security Scanning

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  schedule:
    # Run security scans every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '20.x'

jobs:
  # CodeQL security analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # Dependency vulnerability scanning
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  # npm audit with detailed reporting
  npm-audit:
    name: npm Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate --json > audit-report.json || true
          npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Generate audit summary
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY

          if [ -f audit-report.json ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat audit-report.json | jq '.metadata.vulnerabilities' >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            # Extract critical/high vulnerabilities
            CRITICAL=$(cat audit-report.json | jq -r '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat audit-report.json | jq -r '.metadata.vulnerabilities.high // 0')

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "**High:** $HIGH" >> $GITHUB_STEP_SUMMARY

            # Fail if critical vulnerabilities found
            if [ "$CRITICAL" -gt "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Action Required:** Critical vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "Unable to parse audit report" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report-${{ github.sha }}
          path: audit-report.json
          retention-days: 30

  # Secret scanning
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check licenses
        run: |
          npx license-checker --summary > license-summary.txt || true
          npx license-checker --json > license-report.json || true

      - name: Generate license summary
        run: |
          echo "## ðŸ“œ License Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat license-summary.txt >> $GITHUB_STEP_SUMMARY || echo "No license data available" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report-${{ github.sha }}
          path: |
            license-summary.txt
            license-report.json
          retention-days: 30

  # SAST (Static Application Security Testing)
  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint security rules
        run: |
          npm run lint || true
        continue-on-error: true

      - name: Security-focused code scan
        run: |
          echo "## ðŸ” SAST Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scanning for common security issues..." >> $GITHUB_STEP_SUMMARY

          # Check for common security anti-patterns
          echo "### Potential Security Issues" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Check for eval usage
          EVAL_COUNT=$(grep -r "eval(" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" | wc -l || echo "0")
          echo "eval() usage: $EVAL_COUNT" >> $GITHUB_STEP_SUMMARY

          # Check for dangerouslySetInnerHTML
          INNER_HTML=$(grep -r "dangerouslySetInnerHTML" src/ --include="*.jsx" --include="*.tsx" | wc -l || echo "0")
          echo "dangerouslySetInnerHTML usage: $INNER_HTML" >> $GITHUB_STEP_SUMMARY

          # Check for localStorage without sanitization
          LOCAL_STORAGE=$(grep -r "localStorage.setItem" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" | wc -l || echo "0")
          echo "localStorage.setItem usage: $LOCAL_STORAGE" >> $GITHUB_STEP_SUMMARY

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # All security checks passed
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql, npm-audit, secret-scanning, license-check, sast-scan]
    if: always()
    steps:
      - name: Check security status
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CODEQL_STATUS="${{ needs.codeql.result }}"
          AUDIT_STATUS="${{ needs.npm-audit.result }}"
          SECRET_STATUS="${{ needs.secret-scanning.result }}"
          LICENSE_STATUS="${{ needs.license-check.result }}"
          SAST_STATUS="${{ needs.sast-scan.result }}"

          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | $CODEQL_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| npm Audit | $AUDIT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | $SECRET_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | $LICENSE_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST Scan | $SAST_STATUS |" >> $GITHUB_STEP_SUMMARY

          # Check if any critical checks failed
          if [ "$CODEQL_STATUS" == "failure" ] || [ "$AUDIT_STATUS" == "failure" ] || [ "$SECRET_STATUS" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Critical security issues detected!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All security checks passed**" >> $GITHUB_STEP_SUMMARY
          fi
