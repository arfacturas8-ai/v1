# ====================================================
# CRYB Platform - Elasticsearch Production Configuration
# Optimized for memory usage, performance, and reliability
# ====================================================

# Cluster Configuration
cluster.name: cryb-search-cluster
node.name: cryb-search-node-1
node.roles: [ master, data, ingest, ml ]
discovery.type: single-node

# Network Configuration
network.host: 0.0.0.0
http.port: 9200
transport.port: 9300

# Path Configuration
path.data: /usr/share/elasticsearch/data
path.logs: /usr/share/elasticsearch/logs

# Memory Settings
bootstrap.memory_lock: true
indices.memory.index_buffer_size: 20%
indices.memory.min_index_buffer_size: 96mb

# Circuit Breaker Settings (Critical for Memory Management)
indices.breaker.total.use_real_memory: true
indices.breaker.total.limit: 85%
indices.breaker.fielddata.limit: 30%
indices.breaker.request.limit: 40%
indices.breaker.in_flight_requests.limit: 100%

# Query Cache Settings
indices.queries.cache.size: 15%
indices.queries.cache.count: 10000

# Request Cache Settings  
indices.requests.cache.size: 5%
indices.requests.cache.expire: 60m

# Index Settings Defaults
index.number_of_shards: 1
index.number_of_replicas: 1
index.refresh_interval: 30s
index.max_result_window: 10000
index.max_rescore_window: 10000
index.max_inner_result_window: 100
index.max_terms_count: 65536

# Index Buffer and Merge Settings
index.merge.policy.max_merge_at_once: 5
index.merge.policy.segments_per_tier: 5
index.translog.flush_threshold_size: 512mb
index.translog.sync_interval: 30s
index.translog.durability: async

# Search Settings
search.max_buckets: 65536
search.max_open_scroll_context: 500
search.default_search_timeout: 30s
search.low_level_cancellation: true
search.keep_alive_interval: 60s

# Indexing Settings
index.codec: best_compression
index.store.preload: ["nvd", "dvd"]
index.queries.cache.enabled: true
index.requests.cache.enable: true
index.soft_deletes.enabled: true
index.soft_deletes.retention_lease.period: 12h

# Thread Pool Settings
thread_pool.search.size: 13
thread_pool.search.queue_size: 1000
thread_pool.write.size: 13
thread_pool.write.queue_size: 10000
thread_pool.get.size: 13
thread_pool.get.queue_size: 1000

# Discovery and Recovery
discovery.zen.ping_timeout: 30s
discovery.zen.join_timeout: 60s
gateway.recover_after_time: 5m
gateway.expected_nodes: 1
gateway.recover_after_nodes: 1

# Action Settings
action.destructive_requires_name: true
action.auto_create_index: true

# Security (Development - Disabled)
xpack.security.enabled: false
xpack.security.enrollment.enabled: false
xpack.security.http.ssl.enabled: false
xpack.security.transport.ssl.enabled: false

# Monitoring
xpack.monitoring.enabled: true
xpack.monitoring.collection.enabled: true

# Machine Learning
xpack.ml.enabled: true
xpack.ml.max_machine_memory_percent: 30

# Watcher (Disabled for memory)
xpack.watcher.enabled: false

# Graph (Disabled for memory)
xpack.graph.enabled: false

# CCR (Disabled for memory)
xpack.ccr.enabled: false

# ILM (Index Lifecycle Management)
xpack.ilm.enabled: true

# Disk Allocation
cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 85%
cluster.routing.allocation.disk.watermark.high: 90%
cluster.routing.allocation.disk.watermark.flood_stage: 95%

# Slow Log Settings
index.search.slowlog.threshold.query.warn: 10s
index.search.slowlog.threshold.query.info: 5s
index.search.slowlog.threshold.query.debug: 2s
index.search.slowlog.threshold.fetch.warn: 1s
index.search.slowlog.threshold.fetch.info: 800ms
index.search.slowlog.threshold.fetch.debug: 500ms

index.indexing.slowlog.threshold.index.warn: 10s
index.indexing.slowlog.threshold.index.info: 5s
index.indexing.slowlog.threshold.index.debug: 2s

# GC Log Settings
-XX:+UseG1GC
-XX:MaxGCPauseMillis=400
-XX:+UseStringDeduplication

# JVM Heap Dump Settings
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/usr/share/elasticsearch/logs/

# Performance Tuning
logger.org.elasticsearch.indices.recovery: DEBUG
logger.org.elasticsearch.cluster.service: DEBUG