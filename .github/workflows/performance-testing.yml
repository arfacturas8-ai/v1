name: Performance Testing Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of performance test to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - api-only
          - websocket-only
          - database-only
      duration:
        description: 'Test duration override (minutes)'
        required: false
        default: '5'
        type: string

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'

jobs:
  # ==============================================
  # API PERFORMANCE TESTING
  # ==============================================
  api-performance-tests:
    name: API Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'api-only' || github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: cryb
          POSTGRES_PASSWORD: cryb_password
          POSTGRES_DB: cryb_perf_api
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Artillery
        run: npm install -g artillery@latest

      - name: Setup performance test environment
        run: |
          cp .env.example .env.perf
          echo "DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_perf_api" >> .env.perf
          echo "REDIS_URL=redis://localhost:6379" >> .env.perf
          echo "JWT_SECRET=test-secret-key-for-perf" >> .env.perf
          echo "NODE_ENV=production" >> .env.perf

      - name: Build and start API
        run: |
          cd apps/api
          pnpm exec prisma migrate deploy
          pnpm run build
          pnpm start &
          sleep 30
        env:
          DATABASE_URL: postgresql://cryb:cryb_password@localhost:5432/cryb_perf_api

      - name: Warm up API endpoints
        run: |
          curl -f http://localhost:3000/health || echo "Health check failed"
          sleep 5

      - name: Run API load tests
        run: |
          cd tests/performance
          
          # Modify test duration if specified
          if [ "${{ github.event.inputs.duration }}" != "" ]; then
            sed -i "s/duration: [0-9]*/duration: $((${{ github.event.inputs.duration }} * 60))/g" load-test-config.yml
          fi
          
          artillery run load-test-config.yml --output api-load-report.json
          artillery report api-load-report.json --output api-load-report.html

      - name: Analyze API performance results
        run: |
          cd tests/performance
          
          # Extract key metrics
          P50=$(cat api-load-report.json | jq '.aggregate.latency.p50')
          P95=$(cat api-load-report.json | jq '.aggregate.latency.p95')
          P99=$(cat api-load-report.json | jq '.aggregate.latency.p99')
          RPS=$(cat api-load-report.json | jq '.aggregate.rps.mean')
          ERROR_RATE=$(cat api-load-report.json | jq '.aggregate.errors | length')
          
          echo "## API Performance Results" > api-performance-summary.md
          echo "- **P50 Response Time**: ${P50}ms" >> api-performance-summary.md
          echo "- **P95 Response Time**: ${P95}ms" >> api-performance-summary.md
          echo "- **P99 Response Time**: ${P99}ms" >> api-performance-summary.md
          echo "- **Average RPS**: ${RPS}" >> api-performance-summary.md
          echo "- **Error Count**: ${ERROR_RATE}" >> api-performance-summary.md
          
          # Performance thresholds
          if (( $(echo "$P95 > 2000" | bc -l) )); then
            echo "âŒ **PERFORMANCE ISSUE**: P95 response time (${P95}ms) exceeds 2000ms threshold" >> api-performance-summary.md
            exit 1
          else
            echo "âœ… **PERFORMANCE GOOD**: P95 response time (${P95}ms) within acceptable limits" >> api-performance-summary.md
          fi

      - name: Upload API performance results
        uses: actions/upload-artifact@v3
        with:
          name: api-performance-results
          path: |
            tests/performance/api-load-report.html
            tests/performance/api-load-report.json
            tests/performance/api-performance-summary.md

  # ==============================================
  # WEBSOCKET PERFORMANCE TESTING
  # ==============================================
  websocket-performance-tests:
    name: WebSocket Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'websocket-only' || github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: cryb
          POSTGRES_PASSWORD: cryb_password
          POSTGRES_DB: cryb_perf_ws
        ports:
          - 5432:5432

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Artillery with WebSocket support
        run: npm install -g artillery@latest

      - name: Setup WebSocket test environment
        run: |
          cp .env.example .env.perf
          echo "DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_perf_ws" >> .env.perf
          echo "REDIS_URL=redis://localhost:6379" >> .env.perf
          echo "JWT_SECRET=test-secret-key-for-perf" >> .env.perf
          echo "NODE_ENV=production" >> .env.perf

      - name: Build and start applications
        run: |
          cd apps/api
          pnpm exec prisma migrate deploy
          pnpm run build
          pnpm start &
          sleep 30
        env:
          DATABASE_URL: postgresql://cryb:cryb_password@localhost:5432/cryb_perf_ws

      - name: Run WebSocket load tests
        run: |
          cd tests/performance
          
          # Modify test duration if specified
          if [ "${{ github.event.inputs.duration }}" != "" ]; then
            sed -i "s/duration: [0-9]*/duration: $((${{ github.event.inputs.duration }} * 60))/g" websocket-load-test.yml
          fi
          
          artillery run websocket-load-test.yml --output websocket-load-report.json
          artillery report websocket-load-report.json --output websocket-load-report.html

      - name: Analyze WebSocket performance results
        run: |
          cd tests/performance
          
          # Extract WebSocket-specific metrics
          CONNECTION_TIME=$(cat websocket-load-report.json | jq '.aggregate.latency.p95')
          MESSAGE_RATE=$(cat websocket-load-report.json | jq '.aggregate.rps.mean')
          
          echo "## WebSocket Performance Results" > websocket-performance-summary.md
          echo "- **Connection P95 Time**: ${CONNECTION_TIME}ms" >> websocket-performance-summary.md
          echo "- **Message Rate**: ${MESSAGE_RATE} msg/sec" >> websocket-performance-summary.md
          
          # WebSocket performance thresholds
          if (( $(echo "$CONNECTION_TIME > 1000" | bc -l) )); then
            echo "âŒ **WEBSOCKET ISSUE**: Connection time (${CONNECTION_TIME}ms) exceeds 1000ms threshold" >> websocket-performance-summary.md
            exit 1
          else
            echo "âœ… **WEBSOCKET GOOD**: Connection time (${CONNECTION_TIME}ms) within acceptable limits" >> websocket-performance-summary.md
          fi

      - name: Upload WebSocket performance results
        uses: actions/upload-artifact@v3
        with:
          name: websocket-performance-results
          path: |
            tests/performance/websocket-load-report.html
            tests/performance/websocket-load-report.json
            tests/performance/websocket-performance-summary.md

  # ==============================================
  # DATABASE PERFORMANCE TESTING
  # ==============================================
  database-performance-tests:
    name: Database Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'database-only' || github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: cryb
          POSTGRES_PASSWORD: cryb_password
          POSTGRES_DB: cryb_perf_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Artillery
        run: npm install -g artillery@latest

      - name: Setup database test environment
        run: |
          cp .env.example .env.perf
          echo "DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_perf_db" >> .env.perf
          echo "REDIS_URL=redis://localhost:6379" >> .env.perf
          echo "JWT_SECRET=test-secret-key-for-perf" >> .env.perf
          echo "NODE_ENV=production" >> .env.perf

      - name: Setup database with test data
        run: |
          cd apps/api
          pnpm exec prisma migrate deploy
          
          # Seed database with performance test data
          node -e "
            const { PrismaClient } = require('@prisma/client');
            const prisma = new PrismaClient();
            
            async function seedTestData() {
              console.log('Seeding performance test data...');
              
              // Create test users
              for (let i = 0; i < 100; i++) {
                await prisma.user.create({
                  data: {
                    username: \`perfuser\${i}\`,
                    email: \`perfuser\${i}@test.com\`,
                    password: 'hashedpassword',
                    displayName: \`Performance User \${i}\`
                  }
                });
              }
              
              console.log('Seeded 100 test users');
              await prisma.\$disconnect();
            }
            
            seedTestData().catch(console.error);
          "
        env:
          DATABASE_URL: postgresql://cryb:cryb_password@localhost:5432/cryb_perf_db

      - name: Build and start API for database testing
        run: |
          cd apps/api
          pnpm run build
          pnpm start &
          sleep 30

      - name: Run database load tests
        run: |
          cd tests/performance
          
          # Modify test duration if specified
          if [ "${{ github.event.inputs.duration }}" != "" ]; then
            sed -i "s/duration: [0-9]*/duration: $((${{ github.event.inputs.duration }} * 60))/g" database-load-test.yml
          fi
          
          artillery run database-load-test.yml --output database-load-report.json
          artillery report database-load-report.json --output database-load-report.html

      - name: Analyze database performance results
        run: |
          cd tests/performance
          
          # Extract database-specific metrics
          DB_P95=$(cat database-load-report.json | jq '.aggregate.latency.p95')
          DB_P99=$(cat database-load-report.json | jq '.aggregate.latency.p99')
          DB_RPS=$(cat database-load-report.json | jq '.aggregate.rps.mean')
          
          echo "## Database Performance Results" > database-performance-summary.md
          echo "- **Database P95 Response Time**: ${DB_P95}ms" >> database-performance-summary.md
          echo "- **Database P99 Response Time**: ${DB_P99}ms" >> database-performance-summary.md
          echo "- **Database Operations/sec**: ${DB_RPS}" >> database-performance-summary.md
          
          # Database performance thresholds
          if (( $(echo "$DB_P95 > 3000" | bc -l) )); then
            echo "âŒ **DATABASE ISSUE**: P95 response time (${DB_P95}ms) exceeds 3000ms threshold" >> database-performance-summary.md
            exit 1
          else
            echo "âœ… **DATABASE GOOD**: P95 response time (${DB_P95}ms) within acceptable limits" >> database-performance-summary.md
          fi

      - name: Upload database performance results
        uses: actions/upload-artifact@v3
        with:
          name: database-performance-results
          path: |
            tests/performance/database-load-report.html
            tests/performance/database-load-report.json
            tests/performance/database-performance-summary.md

  # ==============================================
  # PERFORMANCE REPORT GENERATION
  # ==============================================
  generate-performance-report:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    needs: [api-performance-tests, websocket-performance-tests, database-performance-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all performance artifacts
        uses: actions/download-artifact@v3

      - name: Generate comprehensive performance report
        run: |
          echo "# CRYB Platform - Performance Testing Report" > performance-report.md
          echo "Generated at: $(date)" >> performance-report.md
          echo "Test Type: ${{ github.event.inputs.test_type || 'comprehensive' }}" >> performance-report.md
          echo "Test Duration: ${{ github.event.inputs.duration || '5' }} minutes" >> performance-report.md
          echo "" >> performance-report.md
          
          echo "## Performance Test Results Summary" >> performance-report.md
          echo "| Component | Status | Key Metrics |" >> performance-report.md
          echo "|-----------|--------|-------------|" >> performance-report.md
          echo "| API Performance | ${{ needs.api-performance-tests.result }} | P95 < 2000ms |" >> performance-report.md
          echo "| WebSocket Performance | ${{ needs.websocket-performance-tests.result }} | Connection < 1000ms |" >> performance-report.md
          echo "| Database Performance | ${{ needs.database-performance-tests.result }} | P95 < 3000ms |" >> performance-report.md
          echo "" >> performance-report.md
          
          # Include individual summaries if they exist
          if [ -f "api-performance-results/api-performance-summary.md" ]; then
            echo "## API Performance Details" >> performance-report.md
            cat api-performance-results/api-performance-summary.md >> performance-report.md
            echo "" >> performance-report.md
          fi
          
          if [ -f "websocket-performance-results/websocket-performance-summary.md" ]; then
            echo "## WebSocket Performance Details" >> performance-report.md
            cat websocket-performance-results/websocket-performance-summary.md >> performance-report.md
            echo "" >> performance-report.md
          fi
          
          if [ -f "database-performance-results/database-performance-summary.md" ]; then
            echo "## Database Performance Details" >> performance-report.md
            cat database-performance-results/database-performance-summary.md >> performance-report.md
            echo "" >> performance-report.md
          fi
          
          # Overall assessment
          if [ "${{ needs.api-performance-tests.result }}" == "success" ] && 
             [ "${{ needs.websocket-performance-tests.result }}" == "success" ] && 
             [ "${{ needs.database-performance-tests.result }}" == "success" ]; then
            echo "## ðŸš€ **OVERALL PERFORMANCE STATUS: EXCELLENT**" >> performance-report.md
            echo "All performance tests passed. The platform meets all performance requirements." >> performance-report.md
          else
            echo "## âš ï¸ **OVERALL PERFORMANCE STATUS: NEEDS ATTENTION**" >> performance-report.md
            echo "Some performance tests failed. Please review the detailed results and optimize accordingly." >> performance-report.md
          fi

      - name: Upload comprehensive performance report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-performance-report
          path: performance-report.md

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ“Š Performance Testing Results\n\n' + report
            });