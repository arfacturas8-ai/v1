# ==============================================
# CRYB PLATFORM - SECURITY SCANNING PIPELINE
# ==============================================
# Comprehensive security scanning and compliance
# ==============================================

name: ğŸ›¡ï¸ Security Scanning

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  push:
    branches: [main, production, develop]
  pull_request:
    branches: [main, production]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - container
          - infrastructure

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'

jobs:
  # ==============================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ==============================================
  dependency-scan:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'dependencies' || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    strategy:
      matrix:
        component: [api, mobile, web]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        working-directory: ./apps/${{ matrix.component }}
      
      - name: ğŸ”’ NPM Audit
        run: |
          npm audit --audit-level=moderate --json > npm-audit-${{ matrix.component }}.json
          npm audit --audit-level=moderate
        working-directory: ./apps/${{ matrix.component }}
        continue-on-error: true
      
      - name: ğŸ›¡ï¸ Snyk Dependency Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: >
            --severity-threshold=medium
            --file=./apps/${{ matrix.component }}/package.json
            --json-file-output=snyk-${{ matrix.component }}.json
        continue-on-error: true
      
      - name: ğŸ” RetireJS Scan
        run: |
          npx retire --js --outputformat json --outputpath retire-${{ matrix.component }}.json --path ./apps/${{ matrix.component }}
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports-${{ matrix.component }}
          path: |
            npm-audit-${{ matrix.component }}.json
            snyk-${{ matrix.component }}.json
            retire-${{ matrix.component }}.json
          retention-days: 30

  # ==============================================
  # CONTAINER SECURITY SCANNING
  # ==============================================
  container-scan:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'container' || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ—ï¸ Build Test Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile.optimized
          push: false
          tags: cryb-api:security-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ğŸ” Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'cryb-api:security-scan'
          format: 'sarif'
          output: 'trivy-container-results.sarif'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
      
      - name: ğŸ” Grype Container Scan
        uses: anchore/scan-action@v3
        with:
          image: 'cryb-api:security-scan'
          output-format: 'sarif'
          output-file: 'grype-container-results.sarif'
      
      - name: ğŸ” Snyk Container Scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: 'cryb-api:security-scan'
          args: --severity-threshold=medium --json-file-output=snyk-container.json
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Container Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: |
            trivy-container-results.sarif
            grype-container-results.sarif
      
      - name: ğŸ“¤ Upload Security Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: container-security-reports
          path: |
            trivy-container-results.sarif
            grype-container-results.sarif
            snyk-container.json
          retention-days: 30

  # ==============================================
  # INFRASTRUCTURE SECURITY SCANNING
  # ==============================================
  infrastructure-scan:
    name: ğŸ—ï¸ Infrastructure Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'infrastructure' || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Install Security Tools
        run: |
          pip install checkov bandit safety
          
          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          
          # Install terrascan
          curl -L "$(curl -s https://api.github.com/repos/tenable/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" > terrascan.tar.gz
          tar -xf terrascan.tar.gz
          sudo mv terrascan /usr/local/bin
      
      - name: ğŸ” Terraform Security Scan (tfsec)
        run: |
          tfsec ./infrastructure/terraform --format json --out tfsec-results.json
        continue-on-error: true
      
      - name: ğŸ” Terraform Security Scan (Checkov)
        run: |
          checkov -d ./infrastructure/terraform --framework terraform --output json --output-file checkov-terraform.json
        continue-on-error: true
      
      - name: ğŸ” Kubernetes Security Scan (Checkov)
        run: |
          checkov -d ./infrastructure/kubernetes --framework kubernetes --output json --output-file checkov-k8s.json
        continue-on-error: true
      
      - name: ğŸ” Docker Security Scan (Checkov)
        run: |
          checkov -f ./apps/api/Dockerfile.optimized --framework dockerfile --output json --output-file checkov-docker.json
        continue-on-error: true
      
      - name: ğŸ” Terrascan IaC Scan
        run: |
          terrascan scan -d ./infrastructure/terraform -o json --output-file terrascan-results.json
        continue-on-error: true
      
      - name: ğŸ” YAML Security Scan
        run: |
          find ./infrastructure -name "*.yaml" -o -name "*.yml" | xargs checkov -f --framework kubernetes --output json --output-file checkov-yaml.json
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Infrastructure Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-security-reports
          path: |
            tfsec-results.json
            checkov-*.json
            terrascan-results.json
          retention-days: 30

  # ==============================================
  # STATIC CODE ANALYSIS
  # ==============================================
  sast-scan:
    name: ğŸ” Static Application Security Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          pip install bandit semgrep
        working-directory: ./apps/api
      
      - name: ğŸ” CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript,typescript
          queries: security-and-quality
          config-file: ./.github/codeql/codeql-config.yml
      
      - name: ğŸ” Semgrep SAST Scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/typescript
            p/docker
            p/kubernetes
          generateSarif: "1"
      
      - name: ğŸ” ESLint Security Scan
        run: |
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-security.json || true
        working-directory: ./apps/api
      
      - name: ğŸ” Bandit Python Security Scan
        run: |
          find . -name "*.py" -exec bandit -f json -o bandit-results.json {} + || true
      
      - name: ğŸ“¤ Upload SAST Results
        uses: actions/upload-artifact@v4
        with:
          name: sast-security-reports
          path: |
            eslint-security.json
            bandit-results.json
          retention-days: 30

  # ==============================================
  # SECRET SCANNING
  # ==============================================
  secret-scan:
    name: ğŸ” Secret Scanning
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified --json --output trufflehog-results.json
        continue-on-error: true
      
      - name: ğŸ” GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          config-path: .gitleaks.toml
          report-format: json
          report-path: gitleaks-results.json
        continue-on-error: true
      
      - name: ğŸ” Detect Secrets Scan
        run: |
          pip install detect-secrets
          detect-secrets scan --all-files --output detect-secrets-results.json || true
      
      - name: ğŸ“¤ Upload Secret Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: |
            trufflehog-results.json
            gitleaks-results.json
            detect-secrets-results.json
          retention-days: 30

  # ==============================================
  # COMPLIANCE CHECKS
  # ==============================================
  compliance-scan:
    name: âœ… Compliance Checks
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” GDPR Compliance Check
        run: |
          # Check for GDPR compliance patterns
          echo "Checking GDPR compliance..."
          
          # Look for data processing consent
          grep -r "consent" ./apps/api/src || echo "No consent patterns found"
          
          # Check for data retention policies
          grep -r "retention" ./apps/api/src || echo "No retention patterns found"
          
          # Check for right to deletion
          grep -r "delete.*user" ./apps/api/src || echo "No deletion patterns found"
          
          echo "GDPR compliance check completed"
      
      - name: ğŸ” SOC2 Compliance Check
        run: |
          echo "Checking SOC2 compliance..."
          
          # Check for audit logging
          grep -r "audit" ./apps/api/src || echo "No audit patterns found"
          
          # Check for access controls
          grep -r "authorization\|permission" ./apps/api/src || echo "No access control patterns found"
          
          echo "SOC2 compliance check completed"
      
      - name: ğŸ” PCI DSS Compliance Check
        run: |
          echo "Checking PCI DSS compliance..."
          
          # Check for encryption patterns
          grep -r "encrypt\|crypto" ./apps/api/src || echo "No encryption patterns found"
          
          # Check for secure transmission
          grep -r "https\|tls\|ssl" ./apps/api/src || echo "No secure transmission patterns found"
          
          echo "PCI DSS compliance check completed"

  # ==============================================
  # SECURITY REPORT GENERATION
  # ==============================================
  generate-report:
    name: ğŸ“Š Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, infrastructure-scan, sast-scan, secret-scan, compliance-scan]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download All Security Reports
        uses: actions/download-artifact@v4
        with:
          path: security-reports
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“Š Generate Comprehensive Security Report
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          
          # Initialize report
          report = {
              "scan_date": datetime.now().isoformat(),
              "repository": "${{ github.repository }}",
              "commit": "${{ github.sha }}",
              "actor": "${{ github.actor }}",
              "summary": {
                  "total_vulnerabilities": 0,
                  "critical": 0,
                  "high": 0,
                  "medium": 0,
                  "low": 0
              },
              "components": {}
          }
          
          # Process all security reports
          for root, dirs, files in os.walk("security-reports"):
              for file in files:
                  if file.endswith('.json'):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r') as f:
                              data = json.load(f)
                              # Process and aggregate data
                              print(f"Processing {file}")
                      except Exception as e:
                          print(f"Error processing {file}: {e}")
          
          # Save comprehensive report
          with open("comprehensive-security-report.json", "w") as f:
              json.dump(report, f, indent=2)
          
          print("Security report generated successfully")
          EOF
      
      - name: ğŸ“¤ Upload Comprehensive Report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report
          path: comprehensive-security-report.json
          retention-days: 90
      
      - name: ğŸ“¢ Send Security Alert
        if: ${{ contains(needs.*.result, 'failure') }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: |
            ğŸš¨ Security vulnerabilities detected!
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}
            
            Please review the security report and address critical issues immediately.
      
      - name: ğŸ“§ Email Security Report
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ›¡ï¸ CRYB Platform - Security Scan Report"
          to: ${{ secrets.SECURITY_EMAIL_LIST }}
          from: "CRYB Security <security@cryb.ai>"
          attachments: comprehensive-security-report.json
          body: |
            Security scan completed for CRYB Platform.
            
            Details:
            - Repository: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Scan Date: ${{ github.event.head_commit.timestamp }}
            - Triggered by: ${{ github.actor }}
            
            Please review the attached comprehensive security report.
            
            Security Dashboard: https://security.cryb.ai