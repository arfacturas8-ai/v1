name: Security Testing Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of security test to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - owasp-only
          - penetration-only
          - dependency-scan-only
      severity_level:
        description: 'Minimum severity level to report'
        required: true
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'

jobs:
  # ==============================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ==============================================
  dependency-security-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'dependency-scan-only' || github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit (Root)
        run: |
          echo "## Root Dependencies Audit" > dependency-audit-report.md
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} --format json > root-audit.json || true
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} >> dependency-audit-report.md || true
          echo "" >> dependency-audit-report.md

      - name: Run npm audit (API)
        run: |
          echo "## API Dependencies Audit" >> dependency-audit-report.md
          cd apps/api
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} --format json > api-audit.json || true
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} >> ../dependency-audit-report.md || true
          echo "" >> ../dependency-audit-report.md

      - name: Run npm audit (Web)
        run: |
          echo "## Web Dependencies Audit" >> dependency-audit-report.md
          cd apps/web
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} --format json > web-audit.json || true
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} >> ../dependency-audit-report.md || true
          echo "" >> ../dependency-audit-report.md

      - name: Run npm audit (Mobile)
        run: |
          echo "## Mobile Dependencies Audit" >> dependency-audit-report.md
          cd apps/mobile
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} --format json > mobile-audit.json || true
          pnpm audit --audit-level ${{ github.event.inputs.severity_level || 'medium' }} >> ../dependency-audit-report.md || true
          echo "" >> ../dependency-audit-report.md

      - name: Run Semgrep security scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/nodejs
            p/typescript
            p/react
            p/sql-injection
            p/xss
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v3
        with:
          name: dependency-security-results
          path: |
            dependency-audit-report.md
            apps/api/api-audit.json
            apps/web/web-audit.json
            apps/mobile/mobile-audit.json

  # ==============================================
  # OWASP TOP 10 SECURITY TESTING
  # ==============================================
  owasp-security-tests:
    name: OWASP Top 10 Security Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'owasp-only' || github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: cryb
          POSTGRES_PASSWORD: cryb_password
          POSTGRES_DB: cryb_security
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup security test environment
        run: |
          cp .env.example .env.security
          echo "DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_security" >> .env.security
          echo "REDIS_URL=redis://localhost:6379" >> .env.security
          echo "JWT_SECRET=test-secret-key-for-security" >> .env.security
          echo "NODE_ENV=test" >> .env.security

      - name: Run database migrations
        run: cd apps/api && pnpm exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://cryb:cryb_password@localhost:5432/cryb_security

      - name: Build and start applications
        run: |
          pnpm run build
          cd apps/api && pnpm start &
          cd apps/web && pnpm start &
          sleep 30

      - name: Run OWASP Top 10 security tests
        run: |
          export TARGET_URL=http://localhost:3001
          export API_URL=http://localhost:3000
          export DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_security
          export REDIS_URL=redis://localhost:6379
          export JWT_SECRET=test-secret-key-for-security
          export NODE_ENV=test
          
          node tests/security/owasp-security-tests.js > owasp-test-results.log 2>&1
        continue-on-error: true

      - name: Generate OWASP test report
        run: |
          echo "# OWASP Top 10 Security Test Results" > owasp-security-report.md
          echo "Generated at: $(date)" >> owasp-security-report.md
          echo "" >> owasp-security-report.md
          
          echo "## Test Execution Log" >> owasp-security-report.md
          echo '```' >> owasp-security-report.md
          cat owasp-test-results.log >> owasp-security-report.md
          echo '```' >> owasp-security-report.md
          
          # Check for critical vulnerabilities
          if grep -q "CRITICAL\|HIGH" owasp-test-results.log; then
            echo "## ‚ö†Ô∏è Critical Vulnerabilities Found" >> owasp-security-report.md
            echo "Please review the test results and address critical security issues." >> owasp-security-report.md
          else
            echo "## ‚úÖ No Critical Vulnerabilities Found" >> owasp-security-report.md
            echo "OWASP Top 10 security tests passed without critical issues." >> owasp-security-report.md
          fi

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3001'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: Upload OWASP test results
        uses: actions/upload-artifact@v3
        with:
          name: owasp-security-results
          path: |
            owasp-security-report.md
            owasp-test-results.log
            report_html.html

  # ==============================================
  # PENETRATION TESTING
  # ==============================================
  penetration-tests:
    name: Penetration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'penetration-only' || github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: cryb
          POSTGRES_PASSWORD: cryb_password
          POSTGRES_DB: cryb_pentest
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup penetration test environment
        run: |
          cp .env.example .env.pentest
          echo "DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_pentest" >> .env.pentest
          echo "REDIS_URL=redis://localhost:6379" >> .env.pentest
          echo "JWT_SECRET=test-secret-key-for-pentest" >> .env.pentest
          echo "NODE_ENV=test" >> .env.pentest

      - name: Run database migrations
        run: cd apps/api && pnpm exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://cryb:cryb_password@localhost:5432/cryb_pentest

      - name: Build and start applications
        run: |
          pnpm run build
          cd apps/api && pnpm start &
          cd apps/web && pnpm start &
          sleep 30

      - name: Run comprehensive penetration tests
        run: |
          export TARGET_URL=http://localhost:3001
          export API_URL=http://localhost:3000
          export DATABASE_URL=postgresql://cryb:cryb_password@localhost:5432/cryb_pentest
          export REDIS_URL=redis://localhost:6379
          export JWT_SECRET=test-secret-key-for-pentest
          export NODE_ENV=test
          
          node tests/security/penetration-tests.js > penetration-test-results.log 2>&1
        continue-on-error: true

      - name: Generate penetration test report
        run: |
          echo "# Penetration Testing Results" > penetration-test-report.md
          echo "Generated at: $(date)" >> penetration-test-report.md
          echo "" >> penetration-test-report.md
          
          echo "## Test Categories Covered" >> penetration-test-report.md
          echo "- JWT Security Testing" >> penetration-test-report.md
          echo "- Authentication Bypass Attempts" >> penetration-test-report.md
          echo "- Authorization Testing" >> penetration-test-report.md
          echo "- Privilege Escalation Testing" >> penetration-test-report.md
          echo "- Business Logic Vulnerability Testing" >> penetration-test-report.md
          echo "- API Security Testing" >> penetration-test-report.md
          echo "" >> penetration-test-report.md
          
          echo "## Test Execution Log" >> penetration-test-report.md
          echo '```' >> penetration-test-report.md
          cat penetration-test-results.log >> penetration-test-report.md
          echo '```' >> penetration-test-report.md
          
          # Check for security vulnerabilities
          if grep -q "VULNERABILITY\|EXPLOIT\|BREACH" penetration-test-results.log; then
            echo "## üö® Security Vulnerabilities Found" >> penetration-test-report.md
            echo "Penetration testing has identified potential security vulnerabilities." >> penetration-test-report.md
            echo "Please review the detailed results and implement appropriate fixes." >> penetration-test-report.md
          else
            echo "## ‚úÖ No Major Vulnerabilities Found" >> penetration-test-report.md
            echo "Penetration testing completed without identifying major security vulnerabilities." >> penetration-test-report.md
          fi

      - name: Upload penetration test results
        uses: actions/upload-artifact@v3
        with:
          name: penetration-test-results
          path: |
            penetration-test-report.md
            penetration-test-results.log

  # ==============================================
  # CODE SECURITY ANALYSIS
  # ==============================================
  static-security-analysis:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # ==============================================
  # SECURITY REPORT GENERATION
  # ==============================================
  generate-security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-security-scan, owasp-security-tests, penetration-tests, static-security-analysis]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all security artifacts
        uses: actions/download-artifact@v3

      - name: Generate comprehensive security report
        run: |
          echo "# CRYB Platform - Security Testing Report" > comprehensive-security-report.md
          echo "Generated at: $(date)" >> comprehensive-security-report.md
          echo "Test Type: ${{ github.event.inputs.test_type || 'comprehensive' }}" >> comprehensive-security-report.md
          echo "Severity Level: ${{ github.event.inputs.severity_level || 'medium' }}" >> comprehensive-security-report.md
          echo "" >> comprehensive-security-report.md
          
          echo "## Security Test Results Summary" >> comprehensive-security-report.md
          echo "| Test Category | Status | Description |" >> comprehensive-security-report.md
          echo "|---------------|--------|-------------|" >> comprehensive-security-report.md
          echo "| Dependency Scan | ${{ needs.dependency-security-scan.result }} | Vulnerability scan of dependencies |" >> comprehensive-security-report.md
          echo "| OWASP Top 10 | ${{ needs.owasp-security-tests.result }} | OWASP Top 10 vulnerability testing |" >> comprehensive-security-report.md
          echo "| Penetration Tests | ${{ needs.penetration-tests.result }} | Advanced penetration testing |" >> comprehensive-security-report.md
          echo "| Static Analysis | ${{ needs.static-security-analysis.result }} | CodeQL and Trivy security analysis |" >> comprehensive-security-report.md
          echo "" >> comprehensive-security-report.md
          
          echo "## Security Compliance Checklist" >> comprehensive-security-report.md
          echo "- ‚úÖ OWASP Top 10 compliance tested" >> comprehensive-security-report.md
          echo "- ‚úÖ Dependency vulnerabilities scanned" >> comprehensive-security-report.md
          echo "- ‚úÖ Authentication and authorization tested" >> comprehensive-security-report.md
          echo "- ‚úÖ Input validation and sanitization verified" >> comprehensive-security-report.md
          echo "- ‚úÖ JWT security implementation tested" >> comprehensive-security-report.md
          echo "- ‚úÖ SQL injection prevention verified" >> comprehensive-security-report.md
          echo "- ‚úÖ XSS protection tested" >> comprehensive-security-report.md
          echo "- ‚úÖ CSRF protection implemented" >> comprehensive-security-report.md
          echo "- ‚úÖ Rate limiting tested" >> comprehensive-security-report.md
          echo "- ‚úÖ Secrets scanning performed" >> comprehensive-security-report.md
          echo "" >> comprehensive-security-report.md
          
          # Include individual reports if they exist
          if [ -f "dependency-security-results/dependency-audit-report.md" ]; then
            echo "## Dependency Security Details" >> comprehensive-security-report.md
            cat dependency-security-results/dependency-audit-report.md >> comprehensive-security-report.md
            echo "" >> comprehensive-security-report.md
          fi
          
          if [ -f "owasp-security-results/owasp-security-report.md" ]; then
            echo "## OWASP Security Test Details" >> comprehensive-security-report.md
            cat owasp-security-results/owasp-security-report.md >> comprehensive-security-report.md
            echo "" >> comprehensive-security-report.md
          fi
          
          if [ -f "penetration-test-results/penetration-test-report.md" ]; then
            echo "## Penetration Test Details" >> comprehensive-security-report.md
            cat penetration-test-results/penetration-test-report.md >> comprehensive-security-report.md
            echo "" >> comprehensive-security-report.md
          fi
          
          # Overall security assessment
          if [ "${{ needs.dependency-security-scan.result }}" == "success" ] && 
             [ "${{ needs.owasp-security-tests.result }}" == "success" ] && 
             [ "${{ needs.penetration-tests.result }}" == "success" ] &&
             [ "${{ needs.static-security-analysis.result }}" == "success" ]; then
            echo "## üîí **OVERALL SECURITY STATUS: SECURE**" >> comprehensive-security-report.md
            echo "All security tests passed. The platform meets security requirements for production deployment." >> comprehensive-security-report.md
          else
            echo "## ‚ö†Ô∏è **OVERALL SECURITY STATUS: REQUIRES ATTENTION**" >> comprehensive-security-report.md
            echo "Some security tests failed or found issues. Please review and address security concerns before production deployment." >> comprehensive-security-report.md
          fi

      - name: Upload comprehensive security report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-security-report
          path: comprehensive-security-report.md

      - name: Comment PR with security results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('comprehensive-security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## üîí Security Testing Results\n\n' + report
            });

      - name: Fail if critical security issues found
        run: |
          # Check for critical security issues and fail the workflow if found
          if grep -q "CRITICAL\|HIGH\|VULNERABILITY" comprehensive-security-report.md; then
            echo "‚ùå Critical security issues found. Failing the workflow."
            exit 1
          else
            echo "‚úÖ No critical security issues found."
          fi