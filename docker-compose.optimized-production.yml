# ==============================================
# CRYB PLATFORM - OPTIMIZED PRODUCTION DEPLOYMENT
# ==============================================
# High-performance, scalable production setup with:
# - Multi-container scaling
# - Resource optimization
# - Health checks and recovery
# - Performance monitoring
# - Security hardening
# ==============================================

version: '3.9'

services:
  # ==============================================
  # LOAD BALANCER & SSL TERMINATION
  # ==============================================
  traefik:
    image: traefik:v3.0
    container_name: cryb-traefik
    restart: unless-stopped
    command:
      - "--api.insecure=false"
      - "--api.dashboard=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=ssl@cryb.ai"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
      - "8082:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
      - traefik_logs:/var/log/traefik
    networks:
      - cryb-public
      - cryb-private
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.cryb.ai`)"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$8zUZARsA$$8LCM7vAUgOd0rKbRaKxwK/"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ==============================================
  # API SERVICES (SCALED)
  # ==============================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.optimized
      args:
        BUILD_DATE: ${BUILD_DATE:-now}
        VCS_REF: ${VCS_REF:-unknown}
        VERSION: ${VERSION:-1.0.0}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      HOST: 0.0.0.0
      
      # Database optimized for production
      DATABASE_URL: postgresql://${POSTGRES_USER:-cryb_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cryb}?connection_limit=20&pool_timeout=30&statement_timeout=30000&idle_in_transaction_session_timeout=60000
      DATABASE_POOL_MIN: 5
      DATABASE_POOL_MAX: 20
      
      # Redis with clustering support
      REDIS_URL: redis://redis-master:6379/0
      REDIS_SENTINEL_HOSTS: redis-sentinel-1:26379,redis-sentinel-2:26379,redis-sentinel-3:26379
      REDIS_MASTER_NAME: mymaster
      
      # Performance optimizations
      NODE_OPTIONS: "--max-old-space-size=1024 --optimize-for-size"
      UV_THREADPOOL_SIZE: 128
      
      # Security
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 15m
      REFRESH_TOKEN_EXPIRES_IN: 30d
      TRUST_PROXY: true
      SECURE_COOKIES: true
      
      # Feature flags
      ENABLE_RATE_LIMITING: true
      ENABLE_REQUEST_LOGGING: true
      ENABLE_METRICS: true
      ENABLE_DISTRIBUTED_TRACING: true
      
    volumes:
      - api_logs:/app/logs
      - api_temp:/app/temp
    networks:
      - cryb-private
    depends_on:
      postgres:
        condition: service_healthy
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.cryb.ai`)"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=3001"
      - "traefik.http.routers.api.middlewares=api-ratelimit,api-compress,api-security"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.burst=100"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.average=50"
      - "traefik.http.middlewares.api-compress.compress=true"
      - "traefik.http.middlewares.api-security.headers.forcestsheader=true"
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s

  # ==============================================
  # WEB FRONTEND (SCALED)
  # ==============================================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile.optimized
      args:
        BUILD_DATE: ${BUILD_DATE:-now}
        VCS_REF: ${VCS_REF:-unknown}
        VERSION: ${VERSION:-1.0.0}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: "0.0.0.0"
      NEXT_TELEMETRY_DISABLED: 1
      
      # API Configuration
      NEXT_PUBLIC_API_URL: https://api.cryb.ai
      NEXT_PUBLIC_WS_URL: wss://api.cryb.ai
      NEXT_PUBLIC_APP_URL: https://cryb.ai
      
      # Performance optimization
      NODE_OPTIONS: "--max-old-space-size=2048"
      
      # CDN and caching
      NEXT_PUBLIC_CDN_URL: https://cdn.cryb.ai
      
    volumes:
      - web_cache:/app/.next/cache
      - web_logs:/app/logs
    networks:
      - cryb-private
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`cryb.ai`) || Host(`www.cryb.ai`)"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
      - "traefik.http.routers.web.middlewares=web-compress,web-cache,web-security"
      - "traefik.http.middlewares.web-compress.compress=true"
      - "traefik.http.middlewares.web-cache.headers.customrequestheaders.Cache-Control=max-age=3600"
      - "traefik.http.middlewares.web-security.headers.forcestsheader=true"
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ==============================================
  # DATABASE CLUSTER
  # ==============================================
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: cryb-postgres-master
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-cryb_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-cryb}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
      
      # Replication settings
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
      
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - postgres_config:/etc/postgresql
      - postgres_logs:/var/log/postgresql
      - ./config/postgres/postgresql-master.conf:/etc/postgresql/postgresql.conf:ro
      - ./scripts/init-db-optimized.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - cryb-private
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c max_connections=200
      -c shared_buffers=512MB
      -c effective_cache_size=2GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=32MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=8MB
      -c min_wal_size=2GB
      -c max_wal_size=8GB
      -c max_worker_processes=8
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
      -c max_parallel_maintenance_workers=4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cryb_user} -d ${POSTGRES_DB:-cryb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # ==============================================
  # REDIS CLUSTER WITH SENTINEL
  # ==============================================
  redis-master:
    image: redis:7-alpine
    container_name: cryb-redis-master
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --tcp-backlog 511
      --timeout 0
      --databases 16
      --save 900 1
      --save 300 10
      --save 60 10000
      --hz 10
      --rdbcompression yes
      --rdbchecksum yes
    volumes:
      - redis_master_data:/data
      - redis_config:/usr/local/etc/redis
    networks:
      - cryb-private
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  redis-replica:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --replicaof redis-master 6379
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_replica_data:/data
    networks:
      - cryb-private
    depends_on:
      - redis-master
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 1G

  # ==============================================
  # BACKGROUND WORKERS (SCALED)
  # ==============================================
  worker:
    build:
      context: ./services/workers
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-cryb_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cryb}
      REDIS_URL: redis://redis-master:6379/0
      WORKER_CONCURRENCY: 10
      WORKER_MEMORY_LIMIT: 512
    volumes:
      - worker_logs:/app/logs
      - worker_temp:/app/temp
    networks:
      - cryb-private
    depends_on:
      postgres:
        condition: service_healthy
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==============================================
  # ELASTICSEARCH CLUSTER
  # ==============================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: cryb-elasticsearch-master
    restart: unless-stopped
    environment:
      - node.name=es-master
      - cluster.name=cryb-cluster
      - discovery.seed_hosts=elasticsearch
      - cluster.initial_master_nodes=es-master
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=false
      - xpack.monitoring.collection.enabled=true
    volumes:
      - elasticsearch_master_data:/usr/share/elasticsearch/data
      - elasticsearch_config:/usr/share/elasticsearch/config
      - elasticsearch_logs:/usr/share/elasticsearch/logs
    networks:
      - cryb-private
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=10s"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G

  # ==============================================
  # MINIO CLUSTER
  # ==============================================
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data{1...4} --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
      MINIO_PROMETHEUS_AUTH_TYPE: public
    volumes:
      - minio_data1:/data1
      - minio_data2:/data2
      - minio_data3:/data3
      - minio_data4:/data4
      - minio_config:/root/.minio
    networks:
      - cryb-private
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`cdn.cryb.ai`)"
      - "traefik.http.routers.minio.tls.certresolver=letsencrypt"
      - "traefik.http.services.minio.loadbalancer.server.port=9000"
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

# ==============================================
# NETWORKS
# ==============================================
networks:
  cryb-public:
    driver: bridge
    ipam:
      config:
        - subnet: 172.40.0.0/16
          gateway: 172.40.0.1
  
  cryb-private:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.41.0.0/16
          gateway: 172.41.0.1

# ==============================================
# VOLUMES
# ==============================================
volumes:
  # Traefik
  traefik_letsencrypt:
    driver: local
  traefik_logs:
    driver: local
  
  # Application
  api_logs:
    driver: local
  api_temp:
    driver: local
  web_cache:
    driver: local
  web_logs:
    driver: local
  worker_logs:
    driver: local
  worker_temp:
    driver: local
  
  # Database
  postgres_master_data:
    driver: local
  postgres_config:
    driver: local
  postgres_logs:
    driver: local
  
  # Redis
  redis_master_data:
    driver: local
  redis_replica_data:
    driver: local
  redis_config:
    driver: local
  
  # Elasticsearch
  elasticsearch_master_data:
    driver: local
  elasticsearch_config:
    driver: local
  elasticsearch_logs:
    driver: local
  
  # MinIO
  minio_data1:
    driver: local
  minio_data2:
    driver: local
  minio_data3:
    driver: local
  minio_data4:
    driver: local
  minio_config:
    driver: local

# ==============================================
# CONFIGS
# ==============================================
configs:
  postgres_config:
    file: ./config/postgres/postgresql-optimized.conf
  redis_config:
    file: ./config/redis/redis-optimized.conf
  nginx_config:
    file: ./config/nginx/nginx-optimized.conf