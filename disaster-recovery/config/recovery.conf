# ==============================================
# CRYB Platform Disaster Recovery Configuration
# ==============================================
# Main configuration file for disaster recovery procedures
# Source this file in recovery scripts
# ==============================================

# Database Configuration
DB_HOST="localhost"
DB_PORT="5432"
DB_NAME="cryb_platform"
DB_USER="cryb_user"
DB_PASSWORD=""  # Set via environment variable or .env file

# Backup Configuration
BACKUP_DIR="/backup"
CLEAN_BACKUP_DIR="/backup/clean"
STORAGE_MOUNT="/opt/cryb"

# Recovery Objectives (in seconds)
RTO_CRITICAL=3600    # 1 hour
RTO_MAJOR=14400      # 4 hours
RTO_MINOR=86400      # 24 hours

RPO_DATABASE=900     # 15 minutes
RPO_APPLICATION=3600 # 1 hour
RPO_CONFIG=14400     # 4 hours

# Notification Configuration
NOTIFICATION_WEBHOOK=""           # Slack/Teams webhook URL
SECURITY_WEBHOOK=""              # Security team webhook URL
SECURITY_EMAIL=""                # Security team email
STATUS_PAGE_WEBHOOK=""           # Status page API endpoint

# Service Configuration
API_PORT="3002"
WEB_PORT="3003"
ADMIN_PORT="3007"
MONITORING_PORT="3005"

# Recovery Timeouts (in seconds)
SERVICE_START_TIMEOUT=300        # 5 minutes
DATABASE_RECOVERY_TIMEOUT=1800   # 30 minutes
APPLICATION_START_TIMEOUT=600    # 10 minutes
VALIDATION_TIMEOUT=300           # 5 minutes

# Recovery Options
AUTO_RECOVERY_ENABLED="true"
MAINTENANCE_MODE_ENABLED="true"
ENHANCED_MONITORING_DURATION=86400  # 24 hours after recovery

# Security Configuration
SECURITY_LOCKDOWN_ENABLED="true"
CREDENTIAL_ROTATION_ENABLED="true"
FORENSICS_RETENTION_DAYS=90
QUARANTINE_ENABLED="true"

# Infrastructure Configuration
DOCKER_REGISTRY=""               # Private Docker registry if used
BACKUP_ENCRYPTION_KEY=""         # GPG key for backup encryption
CLOUD_PROVIDER="aws"             # aws, gcp, azure
REGION="us-east-1"
AVAILABILITY_ZONES=("us-east-1a" "us-east-1b" "us-east-1c")

# Monitoring Configuration
PROMETHEUS_URL="http://localhost:9090"
GRAFANA_URL="http://localhost:3000"
ALERTMANAGER_URL="http://localhost:9093"

# Load Balancer Configuration
LOAD_BALANCER_TYPE="nginx"       # nginx, haproxy, aws-alb
HEALTH_CHECK_INTERVAL=30
HEALTH_CHECK_TIMEOUT=10
HEALTH_CHECK_RETRIES=3

# DNS Configuration
DNS_PROVIDER="cloudflare"        # cloudflare, route53, etc.
DNS_FAILOVER_ENABLED="true"
DNS_TTL=300                      # 5 minutes

# SSL/TLS Configuration
SSL_CERT_PATH="/etc/letsencrypt/live/cryb.ai"
SSL_AUTO_RENEWAL="true"
SSL_VALIDATION_METHOD="http"

# Backup Retention Policy
BACKUP_RETENTION_DAILY=30        # Keep daily backups for 30 days
BACKUP_RETENTION_WEEKLY=12       # Keep weekly backups for 12 weeks
BACKUP_RETENTION_MONTHLY=12      # Keep monthly backups for 12 months
BACKUP_RETENTION_YEARLY=7        # Keep yearly backups for 7 years

# Recovery Testing Configuration
RECOVERY_TEST_SCHEDULE="monthly"
RECOVERY_TEST_ENVIRONMENT="staging"
RECOVERY_TEST_NOTIFICATION="true"

# Compliance Configuration
GDPR_COMPLIANCE="true"
CCPA_COMPLIANCE="true"
SOX_COMPLIANCE="false"
HIPAA_COMPLIANCE="false"

# Incident Response Configuration
INCIDENT_ESCALATION_LEVELS=3
INCIDENT_ESCALATION_TIMES=(1800 3600 7200)  # 30min, 1hr, 2hr
INCIDENT_AUTO_ESCALATION="true"

# Communication Templates
INCIDENT_START_MESSAGE="CRYB Platform incident detected. Recovery procedures initiated."
INCIDENT_UPDATE_MESSAGE="CRYB Platform recovery in progress. Estimated completion: %ETA%"
INCIDENT_RESOLVED_MESSAGE="CRYB Platform incident resolved. All services operational."

# Recovery Validation Checks
VALIDATION_CHECKS=(
    "database_connectivity"
    "api_health"
    "web_accessibility"
    "admin_accessibility"
    "authentication_flow"
    "data_integrity"
    "performance_baseline"
)

# Critical Dependencies
CRITICAL_SERVICES=(
    "postgres"
    "redis"
    "api"
    "web"
)

SUPPORTING_SERVICES=(
    "admin"
    "monitoring"
    "security-monitoring"
)

# Recovery Scripts Configuration
RECOVERY_SCRIPTS_DIR="/home/ubuntu/cryb-platform/disaster-recovery/scripts"
RECOVERY_LOGS_DIR="/var/log/disaster-recovery"
RECOVERY_WORKSPACE="/tmp/recovery-workspace"

# Performance Thresholds
CPU_THRESHOLD=80                 # CPU usage percentage
MEMORY_THRESHOLD=85             # Memory usage percentage
DISK_THRESHOLD=90               # Disk usage percentage
RESPONSE_TIME_THRESHOLD=2000    # Response time in milliseconds

# Network Configuration
NETWORK_TIMEOUT=30              # Network timeout in seconds
CONNECTION_RETRIES=3            # Number of connection retries
RETRY_DELAY=5                   # Delay between retries in seconds

# Container Configuration
DOCKER_PULL_TIMEOUT=600         # Docker pull timeout in seconds
CONTAINER_START_TIMEOUT=180     # Container start timeout in seconds
CONTAINER_STOP_TIMEOUT=30       # Container stop timeout in seconds

# Log Configuration
LOG_LEVEL="INFO"                # DEBUG, INFO, WARN, ERROR, CRITICAL
LOG_ROTATION="daily"
LOG_RETENTION_DAYS=30
LOG_MAX_SIZE="100M"

# Maintenance Window Configuration
MAINTENANCE_WINDOW_START="02:00"  # 2 AM UTC
MAINTENANCE_WINDOW_END="04:00"    # 4 AM UTC
MAINTENANCE_WINDOW_TIMEZONE="UTC"

# Recovery Metrics
METRICS_COLLECTION="true"
METRICS_RETENTION_DAYS=90
METRICS_EXPORT_FORMAT="prometheus"

# Third-party Integrations
DATADOG_API_KEY=""
NEWRELIC_LICENSE_KEY=""
SPLUNK_HEC_TOKEN=""
PAGERDUTY_SERVICE_KEY=""

# Advanced Recovery Options
PARALLEL_RECOVERY="true"         # Enable parallel recovery operations
RECOVERY_CHECKPOINTS="true"      # Create checkpoints during recovery
ROLLBACK_ENABLED="true"          # Enable automatic rollback on failure
RECOVERY_SIMULATION="false"      # Dry-run mode for testing

# Geographic Distribution
PRIMARY_REGION="us-east-1"
SECONDARY_REGION="us-west-2"
CROSS_REGION_REPLICATION="true"
FAILOVER_STRATEGY="automatic"    # automatic, manual

# API Configuration
API_RATE_LIMIT=1000             # Requests per minute
API_TIMEOUT=30                  # API timeout in seconds
API_RETRY_ATTEMPTS=3

# Database Specific Configuration
DB_CONNECTION_POOL_SIZE=20
DB_TIMEOUT=30
DB_BACKUP_COMPRESSION="gzip"
DB_BACKUP_ENCRYPTION="true"

# Storage Configuration
STORAGE_TYPE="s3"               # s3, gcs, azure-blob
STORAGE_BUCKET="cryb-backups"
STORAGE_REGION="us-east-1"
STORAGE_ENCRYPTION="true"

# Security Hardening
SECURITY_SCAN_ENABLED="true"
VULNERABILITY_SCAN_SCHEDULE="weekly"
PENETRATION_TEST_SCHEDULE="quarterly"
SECURITY_PATCH_AUTO_APPLY="true"

# Recovery Environment Variables
export RECOVERY_MODE="production"
export RECOVERY_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
export RECOVERY_VERSION="1.0"

# Function to validate configuration
validate_recovery_config() {
    local errors=0
    
    # Check required directories
    if [[ ! -d "$BACKUP_DIR" ]]; then
        echo "ERROR: Backup directory not found: $BACKUP_DIR"
        ((errors++))
    fi
    
    # Check database connectivity
    if ! command -v psql >/dev/null 2>&1; then
        echo "ERROR: PostgreSQL client not installed"
        ((errors++))
    fi
    
    # Check Docker
    if ! command -v docker >/dev/null 2>&1; then
        echo "ERROR: Docker not installed"
        ((errors++))
    fi
    
    # Check required tools
    local required_tools=("curl" "tar" "gzip" "awk" "sed")
    for tool in "${required_tools[@]}"; do
        if ! command -v "$tool" >/dev/null 2>&1; then
            echo "ERROR: Required tool not found: $tool"
            ((errors++))
        fi
    done
    
    if [[ $errors -eq 0 ]]; then
        echo "Recovery configuration validation passed"
        return 0
    else
        echo "Recovery configuration validation failed with $errors errors"
        return 1
    fi
}

# Function to load environment-specific configuration
load_environment_config() {
    local environment="${1:-production}"
    local env_config_file="/home/ubuntu/cryb-platform/disaster-recovery/config/recovery-${environment}.conf"
    
    if [[ -f "$env_config_file" ]]; then
        source "$env_config_file"
        echo "Environment-specific configuration loaded: $environment"
    else
        echo "Environment-specific configuration not found: $env_config_file"
    fi
}

# Auto-load environment configuration if RECOVERY_ENVIRONMENT is set
if [[ -n "${RECOVERY_ENVIRONMENT:-}" ]]; then
    load_environment_config "$RECOVERY_ENVIRONMENT"
fi

echo "CRYB Platform Disaster Recovery Configuration Loaded"
echo "Recovery Version: $RECOVERY_VERSION"
echo "Timestamp: $RECOVERY_TIMESTAMP"